## Face 진행 보고서  
작성자 : 김한빈

20.02.28

Torch 기반 Autoencoder 모델 구현 및 학습하기
- 사진에 대한 학습 및 결과 확인 완료
- Train 파일과 Test 파일 분류
- Deep FaceLab기반의 Autoencoder모델 구현 진행중
- 아직 Torch로 모델을 구현하는데 미숙함이 있어 개발이 늦춰짐
- AE, VAE, WAE, GAN중 어떤 모델을 써야할지 확실히 잡히지 않음
- WAE와 GAN이 가장 성능이 좋아보임(대부분의 모델은 GAN기반)


20.03.02

Autoencoder Test 코드 작성, Autoencoder 학습 데이터 변경
- 학습된 모델을 Test해 결과를 확인해 볼 수 있는 초기 코드 작성 완료
- 64x64크기 이미지에 대해 결과물 생성 가능
- 256크기의 이미지에 대한 학습 진행중
- Deep Face Lab과 같이 한 사람의 다양한 모습을 학습 하는중
- 학습 경과 후 같은 사람의 사진과 다른 사람의 사진을 넣어 결과 확인해 볼 예정
- 256x256크기의 추론도 가능하면 그다음은 병행학습 코드 작성 예정
- Pytorch 밑바닥부터 짜려니 많이 알게되어 좋으나, 그만큼 공부해야 될것도 많음.

20.03.03 김한빈

학습중인 deep face lab 결과 뽑아보기
- 결과가 너무 좋지 않다. target_face데이터에 문제가 있는것으로 판단됨
- 결국 background data, target_face data 모두 다시 찾았다...
- 현재 학습 시작되었고 내일과 2일 뒤 2번에 걸쳐 확인 할 예정

autoencoder 모델 2개 동시에 학습하는 코드 작성
- deepfacelab모델에 맞춰가기 위해선 AE가 2개가 있어야함
- 2개의 AE를 학습하는 코드 작성완료
- 현재는 같은 데이터를 학습하지만 추후 다른 데이터를 학습하는 코드 작성 예정
- 2개의 모델이 같이 학습되니 1epoch당 30초 정도가 소요된다.
- dataparallel이나 subprocessing 모듈을 이용해야 함
- AE의 클래스를 짤 때 encoder, decoder를 변수 대신함수로 변경하여봄
- 함수로 변경할 때는 함수안에 nn.sequential를 쓰는것을 피해야함..오류발생함
- tmux로 학습 진행시켜봄

latent space제어 관련 최신 논문 찾아보기
- 오늘은 디오 영상 찾느라 논문을 찾아보지 못함.


20.03.04 김한빈

학습중인 deep face lab 결과 뽑아보기
- 어제(20.3.3)시작한 Do+Tom Hollnad 학습을 확인하였음
- 확인 결과 error가 0.07이었고 결과값은 자연스럽게 합성되었다.
- 추가 보정 값은 주지 않았으나 얼굴 피부색도 일치하게 합성되었음
- 이전 모델 합성의 문제점은 DO Data에 노이즈가 많아 제대로 합성되지 않았던 것으로 판단된다.
- 다만 얼굴 좌우측에 노이즈가 발생하는 것은 DO데이터가 좋지 못하기 떄문으로 판단됨
- 보정값을 다양하게 수정하였지만 좋지 못한 결과를 확인함

autoencoder 모델 2개 동시에 학습한 결과 확인
- model 자체가 parallel로 처리되지는 않았지만 1epoch 당 18초가 소요됨
- 총 1000epoch을 학습하였고 결과는 잘 생성됨.
- a_data로 학습된 AE모델에 b_data를 넣은 결과 잘 생성이됨..
- 내 예상은 a_Data의 정보를 갖고있는 b_data가 나올거으로 예상했으나. 그냥원래 얼굴이 나옴
- 학습량이 부족하여 latent_space가 특징을 정확히 파악하지 못한것으로 판단
- 학습량을 10000epoch까지 늘려서 돌리는중
- modelA와 modelB에 다른 데이터셋을 입력하여 학습중 (modelA=bg_data, modelB=tf_data) 


20.03.05 김한빈

학습중인 deep face lab 결과 뽑아봅기
- 20.3.3 시작한 DO+Tom Holland 학습을 확인하였음
- 에러 값이 0.05 이나 결과는 육안으로 확인하기 힘든 수준임
- DO+Tom 모델은 오버피팅 날수 있기때문에 중지시킬 예정

autoencoder 모델 2개 동시에 학습
- 현재 24시간 정도 학습 중인데 3000epoch정도 학습되었음
- A,B모델에 AData 결과 추출하였음
- A모델은 오error값은 떨어지나 결과는 오버피팅 발생, B모델은 잘 생성되었음..
- B모델에 모델 자체가 특징 추출을 정확히 하지 못한것으로 판단됨
- 자체 기본 autoencoder에는 문제가 있는것으로 판단되서 Deep facelab 모델을 분석하였음
- DeepFaceLab은 Linear방식으로 변환하였고 Residual block을 첨가하였음.
- 아마 레이어가 3층정도 되는데 Residual Block을 추가하지 못하여서 제대로 특징 학습을 못하는 것으로 판단됨
- 내일은 linear방식으로 autoencoder를 학습해 볼 예정


기획팀(로마님, 계영님)과의 회의
- 현재 사진 1장에 대한 모델을 3월 중순 안으로 끝내야 함
- 그래야 테스트 가 이루어지고 1달 내에 보여줄 수 있음
- 추가적으로 눈,코,입에대한 커스터마이징 생성 모델을 고민해보아야 함
- 처음에는 autoencoder기반을 생각하였지만 최근 동향은 GAN으로 기우는 추세
- autoencoder를 사용한다고 하여도 마지막에 Descriminator 을 반드시 추가하여 모델을 구성함
- 지금 autoencoder의 base model도 학습 후에는 Descriminator을 추가할 예정

20.03.06 김한빈

autoencoder 모델 수정
- autoencoder모델을 DeepFaceLab(dfl)과 비슷하게 수정하였음.
- dfl은 densenet을 사용하였으나, 아직 현 모델에서는 residual block과 dense block을 추가하지 않음
- 초기 모델은 nn.Conv2d(self.nc, self.nef, kernel_size=4, stride=2, padding=1, bias=False)을 3개 쌓았음
- 바뀐 모델은 위 레이어를 1단계 추가하였고 nn.Conv2d(self.nef*4, self.nef*8, kernel_size=3, stride=1, padding=1, bias=False)을 주었음
- 마지막 레이어가 dfl과 같은 형태임,모델을 전부 바꾸려하였으나..가장 첫 레이어에서 바꿀경우 사이즈가 엄청커져 out of memory가 발생....
- CNN모델에서는 kernel_size와 stirde가 모델크기에 많은 영향을 주는것으로 판단됨.
- 그래서 encoder마지막과 decoder의 첫 레이어에만 (4, 2, 1)->(3, 1, 1)형태로 레이어 구성
- 기존 모델 encoder부분 마지막에 Leaky ReLU가 빠져있어서..추가하였음(학습이 잘 안된 원인으로 파악)
- 현 모델 학습이 잘 될 경우 residual block을 추가할 예정
- residual block을 추가한 후 descriminator 추가 예정

수정된 autoencder 모델 학습
- 위에서 설명한 수정된 autoencoder는 1번 gpu에서 학습 중
- 1 epoch당 38초 소요, 주말 이용해 10000epoch까지 돌려볼 예정

background Process정리
- 학습을 진행하려 하였는데 0번 gpu가 사용중이어서 CUDA_VISIBLE_DEVICES=1 을 이용하였는데도 out of memory발생
- python코드 안과 커맨드 입력창에서 모두 시도해보았으나 결과는 똑같았음.
- nvidia-smi에는 0번 gpu에만 메모리 할당되어 있는 것으로 파악함.
- 문제는 레이어를 너무 크게 잡아 변형시켰기 때문이었음
- 그러다 ps -ef로 프로세스를 확인하였음.
- 그러던 중 jjck5938로 예전에 실행시켰던 dfl코드가 백그라운드에서 계속 남아있는 것 파악함
- dfl이 멀티 프로세스를 사용하는데 특정 방법으로 종료하였을 경우 백그라운드에 프로세스가 남아있는 것으로 파악됨
  * 특정 방법은 아직 파악 못함
- ps -ef | grep jjck5938으로 프로세스 검색, kill로 정리하였음.

transpose 원리 파악
- dfl에서 사용하던 transpose원리 파악하였음
- 다음에 볼 수 있도록 관련 링크 첨부함
- 텔레그램에도 공유하였음
[transpose 원리](https://superelement.tistory.com/18)


20.03.09 김한빈

autoencoder 디버깅
- model A와 model B를 학습할때 같은 모델임에도 B만학습되는 오류 수정
- model B를 학습할때 modelA.step이 들어있었음.
- 제거 후 확인 결과 정상적으로 학습됨
- 그러나 DataA를 학습한 모델과 DataB를 학습한 모델 비교 하였음
- DataB로 DataA를 학습한 모델, DataB를 학습한 모델 추론 결과 DataB로 학습한  
  모델이 좀 더 나은 결과를 추출하였으나, DataA로 학습한 모델도 잘 추출함.
- modelA로 DataB를 추론하면 B특징을 갖는 A얼굴이 나타날것 같으니 그렇지 않음.
- Deep Face Lab의 모델을 조금더 분석할 필요가 있음.

autoencoder 모델 수정
- Deep Face Lab과 완전히 똑같이 모델 수정하였음
- Dense Layer추가(torch의 nn.Linear과 같은 기능)
- Layer 수 증가
- Encoder 마지막단에 flatten적용하여 1차원 레이어 추가함
- Encoder와 Decoder의 input 사이즈도 일치시킴
- encoder와 decoder의 자유로운 사용을 위해 class로 다시 구현할 예정
- Batch size가 너무 커서 out of memory 발생하였음
- Batch size를 128로 변경함
- 레이어를 늘렸음에도 batch size 변경으로 학습시간이 34초->28초로 줄어듬

20.03.10 김한빈

autoencoder 모델 수정
- 수정된 모델 결과 확인
- mode collapse일어난 것으로 판단됨.. 학습이 되지 않고 검정화면만 뜸.
- 오늘 내내 conv2d Layer값을 변형하면서 시도하였지만 아직 원인 찾지못함..
- 내일 오전까지 돌려보고 다시 판단 할 예정
- Decoder 네트워크에 문제가 있는 것으로 판단됨.
- 다양하게 수정하였으나 아직까지 감히 잡히지 않음...
- encoder, decoder를 클레스로
- 적절한 네으퉈크가 구성되면 분류된 클레스로 다시 변경할 예정

대표님 보여드릴 자료 조사
- 상욱님과 30분 정도 회의 하였음
- 현재 보유 기술 중 Deep face lab, ATVG net, Talking Face는 내가 정리하기로 함
- 최근데 나온 모델도 살펴보고 정리 할 예정
- 아래 링크에 관련 논문과 소스코드가 많이 제공됨
![SelectionGAN](https://github.com/Ha0Tang/SelectionGAN)

20.03.11 김한빈

VH관련 자료 조사
- 현재 보유하고있는 기술들에 대한 정리 완료
- 참고하거나, 사용가능한 기술들에 대한 자료 조사중
- Style-Based GAN이나 STAR GAN등이 주목할 만한 모델임
- 위 모델은 감정표현이나 스타일 제어가 가능함

autoencoder 모델 수정
- 어제 수정한 모델 확인 결과 동일하게 제대로 생성되지 않음.
- 한가지 특이점은, 모델A에서 얼굴형태를 출력해 내었음
- 신기하게 얼굴부분만 검정색, 그 외에는 초록색으로 출력함
- Decoder네트워크에 문제가 있는 것으로 판단됨.
- Encoding과 Decoding때 피쳐사이즈를 줄이는 방법을 없애야 할것같음
- 피처 사이즈가 줄지 않는 kernel=3, stride=1, padding=1으로 다시 학습예정


20.03.11 김한빈

Deep Face Lab 작업
- 로마님 요청하신 로마님 영상+여자 영상 합성.
- 결과가 좋지 않음(여자 머리카락이 얼굴을 가리기 때문..)
- 다른 영상 찾아볼 예장

VH관련 자료 조사
- PPT작성 완료
- InterFaceGAN, style-basedGAN 자료 추가 작성
- 도입 가능 시기 추가 작성

autoencoder 모델 수정
- Batch normal 코드를 추가하였다.
- Linear다음에도 activation function (ReLU)를 추가하였음.
- 100epoch 테스트 결과 결과가 훨씬 좋아짐
- 깊게 쌓을수록 Batch Normal코드가 필요한 것 같음
- Linear에도 ReLU나 Sigmoid를 넣어야 한다...꼭
- 1epoch 당 10초정도 소요됨


20.03.12 김한빈

autoencoder 모델수정
- 10000epoch학습 결과, 모델 특징을 잘학습함
- A Img를 B 모델에 입력하였을 경우 -> B특징을 갖는 A이미지를 생성함
- 반대로도 가능
- 그러나 아직은 생성 퀄리티가 높지는 않음. 모델 성능 개선 필요
- 결과 확인 후 encoder와 decoder를 다른 클래스로 분리
- encoder는 공유하고 decoder만 따로 학습 하도록 모델 구성
- 모델이 2가지로 늘어나니 학습 속도가 더 빨라짐.
- 50step만 지났는데도 결과가 잘 생성됨.
- 추후 encoder만 여러가지 사람을 이용해 학습해 볼 예정

Deep Face Lab 작업
- 로마님 요청하신 로마님+여자 영상 합성 추가작업.
- 기존에 여자 영상 데이터가 좋지 않아 새로운 영상으로 작업 진행
- 토요일이나 일요일 저녁 쯤에 결과 확인 예정


20.03.16

Deep Face Lab 결과 확인
- 로마님 영상 합성 작업  확인해 본 결과 백그라운드 데이터에 대한 문제점이 약간 있어보임
- 얼굴에 흐릿한 모습들이 나타남

autoencoder 모델 수정
- train모델 저장할 때 netD, netE도 함께 저장하도록 수정하였음

이사 후 회사 정리
- 자리 배치 하였음

20.03.17

Deep Face Lab 결과 작업
- 여러가지 파라미터를 수정하여 출력하였으나 놀랄만한 결과가 나오지는 않았음.


autoencoder 모델 수정
- layer개수 늘렸음
- 기존 레이어 결과 확인하였으나 엄청나게 결과가좋아지지는 않았음

회사 추가 정리
- 가구 옮기고 배치 하였음
